<html>
<head>
    <title>Forest Generator v1.8</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAiPFoAAAAAAES7lQBDwJIAP8CVADzAkAA/v5kAQr+RAB48WwBEv5EAN8GSACA8WwA7wJMAV7yeAEyzlwBGvpUASb+ZAD6/kgAhO10AP76WADHCjQCT1sQAPcGTAEvDnQAkPVsAMUVeAEm7lwA4wZEAPMCSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQEBAQEBAQsYCwEBAQEBAQEBAQEBAQEBEgEBAQEBAQEBAQEBAQEBAQsBAQEBAQEBAQEBAQEBAQEZAQEBAQEBAQEBAQEXHBwBAAEcHAEBAQEBAQEJHBwcFAsVHBwcFgEBAQERHBwcHBwIHBwMHBwcAQEBDBwcHBMcHBwCHBwcBgEBAQQKHAUcHBwOHBwcEAEBAQEBGxwcHBwcGhwcHBwBAQEBARwNHBwcDxwcHBwBAQEBAQEcHBwcHBwcHBwHAQEBAQEBARwcHBwcHBwcAQEBAQEBAQEBHBwcHBwcAQEBAQEBAQEBAQEBHBwDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAf4/AAD/fwAA/38AAP9/AADxTwAA4AMAAMABAADAAQAAwAMAAOADAADgBwAA4AcAAPAPAAD4HwAA/j8AAP//AAA=" rel="icon" type="image/x-icon" />
    <!-- Local asset data -->    
    <script src="talespireslabs.js"></script>
    <script src="assetdata.js"></script>

    <style>
        body {
            font-family: Candara, Calibri, Segoe, "Segoe UI", Optima, Arial, sans-serif;
            margin: 0px;
            padding: 0px;
        }
        *, *:before, *:after {
          box-sizing: border-box;
        }

        .footer {
          float: left;
          left: 0;
          bottom: 0;
          width: 100%;
          background-color: #DDD;
          color: #333;
          text-align: center;
          padding: 20px;
        }
        input:active { 
            outline:none;
        }
        input[type=number] {
            padding:10px;
            border:1;
            box-shadow:0 0 15px 4px rgba(0,0,0,0.06);
            margin-top:10px;
            margin-bottom: 10px;
            margin-left: 10px;
            border-radius:10px;
            width: 100px;
        }        
        .btn-group button {
          outline:none;
          background-color: #4CAF50; /* Green background */
          border: 1px solid green; /* Green border */
          color: white; /* White text */
          padding: 10px 24px; /* Some padding */
          margin-top: 10px;
          margin-right: 22px;
          cursor: pointer; /* Pointer/hand icon */
          float: left; /* Float the buttons side by side */
        }

        .btn-group button:not(:last-child) {
          border-right: none; /* Prevent double borders */
        }

        /* Clear floats (clearfix hack) */
        .btn-group:after {
          content: "";
          clear: both;
          display: table;
        }

        /* Add a background color on hover */
        .btn-group button:hover {
          background-color: #5edb62;
          color: #333;
        }
        textarea {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-left: 3px solid #f36d33;
            color: #666;
            page-break-inside: avoid;
            font-family: monospace;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 1.6em;
            max-width: 100%;
            overflow: auto;
            padding: 1em 1.5em;
            display: block;
            word-wrap: break-word;
        }
        /* The snackbar - position it at the bottom and in the middle of the screen */
        #snackbar {
          visibility: hidden; /* Hidden by default. Visible on click */
          min-width: 250px; /* Set a default minimum width */
          margin-left: -125px; /* Divide value of min-width by 2 */
          background-color: #333; /* Black background color */
          color: #fff; /* White text color */
          text-align: center; /* Centered text */
          border-radius: 2px; /* Rounded borders */
          padding: 16px; /* Padding */
          position: fixed; /* Sit on top of the screen */
          z-index: 1; /* Add a z-index if needed */
          left: 50%; /* Center the snackbar */
          bottom: 30px; /* 30px from the bottom */
        }

        /* Show the snackbar when clicking on a button (class added with JavaScript) */
        #snackbar.show {
          visibility: visible; /* Show the snackbar */
          /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
          However, delay the fade out process for 2.5 seconds */
          -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
          animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        /* Animations to fade the snackbar in and out */
        @-webkit-keyframes fadein {
          from {bottom: 0; opacity: 0;}
          to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadein {
          from {bottom: 0; opacity: 0;}
          to {bottom: 30px; opacity: 1;}
        }

        @-webkit-keyframes fadeout {
          from {bottom: 30px; opacity: 1;}
          to {bottom: 0; opacity: 0;}
        }

        @keyframes fadeout {
          from {bottom: 30px; opacity: 1;}
          to {bottom: 0; opacity: 0;}
        }
        
        .slidecontainer {
          width: 200px; /* Width of the outside container */
        }


        .slider {
          -webkit-appearance: none;
          width: 200px;
          height: 15px;
          border-radius: 5px;
          background: #d3d3d3;
          outline: none;
          opacity: 0.7;
          -webkit-transition: .2s;
          transition: opacity .2s;
        }

        .sliderwide {
          -webkit-appearance: none;
          width: 400px;
          height: 15px;
          border-radius: 5px;
          background: #d3d3d3;
          outline: none;
          opacity: 0.7;
          -webkit-transition: .2s;
          transition: opacity .2s;
        }

        .slider:hover {
          opacity: 1;
        }

        .slider::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 25px;
          height: 25px;
          border-radius: 50%;
          background: #4CAF50;
          cursor: pointer;
        }

        .slider::-moz-range-thumb {
          width: 25px;
          height: 25px;
          border-radius: 50%;
          background: #4CAF50;
          cursor: pointer;
        }
        .sliderheader {
            margin: 10px;
        }
        strong {
            font-size: 150%;
            font-family: monospace;
        }
        .btn {
          background-color: #DDD; /* Blue background */
          border: none; /* Remove borders */
          color: white; /* White text */
          padding: 6px 6px; /* Some padding */
          font-size: 16px; /* Set a font size */
          cursor: pointer; /* Mouse pointer on hover */
          border-radius: 100%;
        }

        .clipboardbutton {
          background-color: #7177c7 !important;/* Blue background */
        }

        .clipboardbutton:hover {
          background-color: #9198f2 !important;/* Blue background */
        }

        .addbtn {
          margin: 20px;
          float: right;
          background-color: #7177c7; /* Blue background */
          border: none; /* Remove borders */
          color: white; /* White text */
          padding: 6px 6px; /* Some padding */
          font-size: 16px; /* Set a font size */
          cursor: pointer; /* Mouse pointer on hover */
          border-radius: 10%;
          font-size: 20px;
        }
        .addbtn:hover {
          background-color: #9198f2;
        }        

        /* Darker background on mouse-over */
        .btn:hover {
          background-color: #AAA;
        }
        /* The Modal (background) */
        .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 1; /* Sit on top */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgb(0,0,0); /* Fallback color */
          background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
          background-color: #fefefe;
          margin: 15% auto; /* 15% from the top and centered */

          padding: 20px;
          padding-bottom: 30px;
          border: 1px solid #888;
          width: 880px; /* Could be more or less, depending on screen size */
        }

        .modal-body {
            font-family: Candara, Calibri, Segoe, "Segoe UI", Optima, Arial, sans-serif;
            font-size: 150%;
          background-color: #fefefe;
          padding: 20px;
          padding-right: 1px;
          width: 100%; /* Could be more or less, depending on screen size */
        }

        /* The Close Button */
        .modalClose {
          color: #DDD;
          float: right;
          font-size: 28px;
          font-weight: bold;
        }

        .modalClose:hover,
        .modalClose:focus {
          color: #AAA;
          text-decoration: none;
          cursor: pointer;
        }
        /* The Close Button */
        .modalOk {
          color: #629632;
          font-size: 28px;
          font-weight: bold;
          float: right;
          margin-top: 10px;
        }

        .modalOk:hover,
        .modalOk:focus {
          color: #6A8455;
          text-decoration: none;
          cursor: pointer;
        }
        .assetTable table {  
            color: #333;
            font-family: Helvetica, Arial, sans-serif;
            border-collapse: 
            collapse; border-spacing: 0; 
            overflow: auto;
        }

        .assetTable td, th {  
            border: 1px solid transparent; /* No more visible border */
            height: 30px; 
            transition: all 0.3s;  /* Simple transition for hover effect */
        }

        .assetTable th {  
            background: #DFDFDF;  /* Darken header a bit */
            font-weight: bold;
            text-align: left
        }

        .assetTable td {  
            background: #FAFAFA;
        }

        /* Cells in even rows (2,4,6...) are one color */        
        .assetTable tr:nth-child(even) td { background: #F1F1F1; }   

        /* Cells in odd rows (1,3,5...) are another (excludes header cells)  */        
        .assetTable tr:nth-child(odd) td { background: #FEFEFE; }
        .row {
          display: flex;
          margin: 20px;
        }
        
        .output {
            width: 400px;
            height: 500px;
            overflow: auto;
            background: #DDD;
            margin-left: 40px;
            border: 1px solid black;
        }

        .tooltip {
          position: relative;
          display: inline-block;
        }

        .tooltip .tooltiptext {
          visibility: hidden;
          width: 270px;
          background-color: #DDD;
          color: black;
          text-align: center;
          border-radius: 6px;
          padding: 5px 0;
          position: absolute;
          z-index: 1;
          bottom: 100%;
          left: 50%;
          margin-left: -70px;
          margin-bottom: 5px;
          
          /* Fade in tooltip - takes 1 second to go from 0% to 100% opac: */
          opacity: 0;
          transition: opacity 0.5s;
        }

        .tooltip:hover .tooltiptext {
          visibility: visible;
          opacity: 1;
        }
    </style>
    <script>
    var builtInCustoms = {
        "builtin-Standard Stacked Pine": "```H4sIAAAAAAAACzv369xFRgZmBu1UR3dX5SWe+65a1e96KV3HyMDA8KspLNDJ+YZr493Nsr9Un04AickzGaVLfn3ltJyR75H7hpo8kBgDw56DDhEJDkCGPRjPr4PQ////B8kxMHywh8sxKEDpBnuInAKm3HYGB4icAMJMKBsADC5RqbAAAAA=```",

        "builtin-Short Stacked Pine": "```H4sIAAAAAAAACzv369xFRgYmBu1UR3dX5SWe+65a1e96KV3HyMDAIM9klC759ZXTcka+R+4bavJAYgwMVw46RAg4MDAoADGDPcP8OnswvXiCPUgOKG4PlwOzgbTz2nsQuQtIchfAcgAQOD7pgAAAAA==```",
    };
    var presetAssets = {
        "mixed": {
            "floors": {"3911d10d-142b-4f33-9fea-5d3a10c53781": 10, "01c3a210-94fb-449f-8c47-993eda3e7126": 100},
            "randoms": [
            {
                "nguid": "fee2bce5-fc53-4eab-bcba-0d7a73e84b49",
                "defaultpercent": 40,
            },
            {
                "nguid": "d5b7910a-ae06-4ad3-91f6-cbbd8782bbea",
                "defaultpercent": 10,
            },
            {
                "nguid": "b557beec-e795-4a65-99c4-0bbb0827077d",
                "defaultpercent": 10,
            },
            {
                "nguid": "4741652b-2345-49a4-bed5-3a7fbae91b7e",
                "defaultpercent": 10,
            },
            {
                "nguid": "ed9bc853-bed5-443c-b45f-a7133d55011a",
                "defaultpercent": 10,
            },
            {
                "nguid": "ff966bc3-dd95-4ca9-a217-1ca16fce6b52",
                "defaultpercent": 10,
            }
            ]
        },
        "sparsepine": {
            "floors": {"3911d10d-142b-4f33-9fea-5d3a10c53781": 20, "01c3a210-94fb-449f-8c47-993eda3e7126": 100},
            "randoms": [
            {
                "nguid": "fee2bce5-fc53-4eab-bcba-0d7a73e84b49",
                "defaultpercent": 40,
            },
            {
                "nguid": "b557beec-e795-4a65-99c4-0bbb0827077d",
                "defaultpercent": 10,
            },
            {
                "nguid": "builtin-Standard Stacked Pine",
                "defaultpercent": 10,
            },
            {
                "nguid": "builtin-Short Stacked Pine",
                "defaultpercent": 10,
            },
            {
                "nguid": "ff966bc3-dd95-4ca9-a217-1ca16fce6b52",
                "defaultpercent": 10,
            },
            {
                "nguid": "4741652b-2345-49a4-bed5-3a7fbae91b7e",
                "defaultpercent": 10,
            }
        ]},
        "heavypine": {
            "floors": {"01c3a210-94fb-449f-8c47-993eda3e7126": 100},
            "randoms": [
            {
                "nguid": "fee2bce5-fc53-4eab-bcba-0d7a73e84b49",
                "defaultpercent": 40,
            },
            {
                "nguid": "b557beec-e795-4a65-99c4-0bbb0827077d",
                "defaultpercent": 10,
            },
            {
                "nguid": "builtin-Standard Stacked Pine",
                "defaultpercent": 40,
            },
            {
                "nguid": "builtin-Short Stacked Pine",
                "defaultpercent": 30,
            },
            {
                "nguid": "ff966bc3-dd95-4ca9-a217-1ca16fce6b52",
                "defaultpercent": 10,
            },
            {
                "nguid": "4741652b-2345-49a4-bed5-3a7fbae91b7e",
                "defaultpercent": 10,
            }
        ]},
        "sparsedead": {
            "floors": {"0582fb0c-9fd0-4355-9bf8-821027ecc74d": 20, "3911d10d-142b-4f33-9fea-5d3a10c53781": 30, "3911d10d-142b-4f33-9fea-5d3a10c53781": 30, "01c3a210-94fb-449f-8c47-993eda3e7126": 100},
            "randoms": [
            {
                "nguid": "fee2bce5-fc53-4eab-bcba-0d7a73e84b49",
                "defaultpercent": 30,
            },
            {
                "nguid": "b557beec-e795-4a65-99c4-0bbb0827077d",
                "defaultpercent": 20,
            },
            {
                "nguid": "ed9bc853-bed5-443c-b45f-a7133d55011a",
                "defaultpercent": 7,
            },
            {
                "nguid": "80c2e070-10eb-4608-87a7-fa3d75e929c2",
                "defaultpercent": 10,
            },
            {
                "nguid": "12f8679e-6100-4da2-a3bd-a3fcc925ab30",
                "defaultpercent": 6,
            },
            {
                "nguid": "2aeacfa9-b84d-418f-86c7-cdb85e2f4c13",
                "defaultpercent": 6,
            }
        ]},
        "heavydead": {
            "floors": {"0582fb0c-9fd0-4355-9bf8-821027ecc74d": 30, "3911d10d-142b-4f33-9fea-5d3a10c53781": 20, "3911d10d-142b-4f33-9fea-5d3a10c53781": 20, "01c3a210-94fb-449f-8c47-993eda3e7126": 100},
            "randoms": [
            {
                "nguid": "fee2bce5-fc53-4eab-bcba-0d7a73e84b49",
                "defaultpercent": 30,
            },
            {
                "nguid": "b557beec-e795-4a65-99c4-0bbb0827077d",
                "defaultpercent": 20,
            },
            {
                "nguid": "ed9bc853-bed5-443c-b45f-a7133d55011a",
                "defaultpercent": 20,
            },
            {
                "nguid": "80c2e070-10eb-4608-87a7-fa3d75e929c2",
                "defaultpercent": 20,
            },
            {
                "nguid": "12f8679e-6100-4da2-a3bd-a3fcc925ab30",
                "defaultpercent": 10,
            },
            {
                "nguid": "2aeacfa9-b84d-418f-86c7-cdb85e2f4c13",
                "defaultpercent": 10,
            }
        ]}
    };

    function GetWeightedValue(weightedDict) {
        weightedArr = [];
        Object.entries(weightedDict).forEach(function (val) {
            for (let j = 0; j < val[1]; ++j) {
                weightedArr.push(val[0]);
            }
        });
        return weightedArr[Math.floor(Math.random() * weightedArr.length)];
    }

    function ShowError(errorMessage, timeout=3000) {
        var x = document.getElementById("snackbar");
        x.innerHTML = errorMessage;
        x.style.backgroundColor = "red";
        x.className = "show";
        var timeoutSeconds = ((timeout / 1000) - 0.5) + "s";
        x.style.webkitAnimation = "fadein 0.5s, fadeout 0.5s " + timeoutSeconds;
        x.style.animation = "fadein 0.5s, fadeout 0.5s " + timeoutSeconds;
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, timeout);
    }

    function ShowMessage(message, timeout=3000) {
        var x = document.getElementById("snackbar");
        x.innerHTML = message;
        x.style.backgroundColor = "black";
        x.className = "show";
        var timeoutSeconds = ((timeout / 1000) - 0.5) + "s";
        x.style.webkitAnimation = "fadein 0.5s, fadeout 0.5s " + timeoutSeconds;
        x.style.animation = "fadein 0.5s, fadeout 0.5s " + timeoutSeconds;
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, timeout);          
    }
    function CopyToClipboard() {
        var forest = document.getElementById("forest");
        forest.select();
        document.execCommand('copy');
        ShowMessage("Slab Copied to Clipboard")
    }

    function clearPrintResults() {
        document.getElementById('output').innerHTML = "";
    }

    function printResults(message) {
        document.getElementById('output').innerHTML += '<p>' + message + '</p>';
    };

    var seed = new Date() / 1000;;
    function random() {
        var x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
    }

    function AddFloor(floors, width, depth, center_height) {
        //console.log("Adding asset: " + nguid + " Width: " + width + " Depth: " + depth + " Height: " + center_height + " Percentage: " + percentage);
        
        // var nguidAssets = [];
        // nguids.forEach(function(nguid) {
        //     nguidAssets.push(TalespireSlabs.GetAsset(nguid));
        // });
        var output = {};
        var heightArray = [];
        for (var w = 0; w < width; w++) {
            for (var d = 0; d < depth; d++) {
                var selectedFloorGuid = GetWeightedValue(floors);
                heightArray.push([w, d, TalespireSlabs.GetAsset(selectedFloorGuid)['height']]);
                //var selectedAsset = Math.floor(random() * nguidAssets.length);
                if (output[selectedFloorGuid] == null) {
                    output[selectedFloorGuid] = [];
                }
                //console.log(center_height);
                output[selectedFloorGuid].push({'rotation': Math.floor(Math.random() * 3) * 4,
                    'bounds': 
                    {
                        'center': {'x': w*2, 'y': center_height, 'z': d*2},
                        'extents': {'x': 1, 'y': 1, 'z': 1}
                    }
                });
            }
        }
        var response = [];
        Object.entries(output).forEach(function(outputItem) {
           response.push({'nguid': outputItem[0], 'assets': outputItem[1]});
        });
        return [response, heightArray];
    }

    function AddAsset(nguid, width, depth, heightArray, percentage) {
        console.log("Adding asset: " + nguid + " Width: " + width + " Depth: " + depth + " Percentage: " + percentage);
        var asset = TalespireSlabs.GetAsset(nguid);
        var assets = [];
        for (var w = 0; w < width; w++) {
            for (var d = 0; d < depth; d++) {
                var center_height;
                //console.log(center_height);
                heightArray.forEach(function (h) {
                    if (h[0] == w && h[1] == d) {
                        center_height = h[2] + 1.13;
                        return;
                    }
                });
                if ((Math.floor(random() * 100) + 1) > percentage) {
                    continue;
                }
                assets.push({'rotation': Math.floor(Math.random() * 3) * 4,
                    'bounds': 
                    {
                        'center': {'x': w*2, 'y': center_height, 'z': d*2},
                        'extents': {'x': 1, 'y': 1, 'z': 1}
                    }
                });
            }
        }
        return {'nguid': nguid, 'assets': assets};
    }

    function AddCustomAsset(customName, width, depth, heightArray, percentage) {
        console.log("Adding custom asset: " + customName + " Width: " + width + " Depth: " + depth + " Percentage: " + percentage);
        var customAssetPayload;
        if (customName.startsWith('builtin')) {
            customAssetPayload = TalespireSlabs.DecodeSlabToPayload(builtInCustoms[customName]);
        } else {
            customAssetPayload = TalespireSlabs.DecodeSlabToPayload(window.localStorage.getItem(customName));
        }

        var assetPayload = [];
        var centerMin = [0,0,0];
        for (var a = 0; a < customAssetPayload.length; a++) {
            if (a > 0) {
                break;
            }
            for (var x = 0; x < customAssetPayload[a]['assets'].length; x++) {
                var asset = customAssetPayload[a]['assets'][x];
                if (a == 0 && x == 0) {
                    centerMin = [asset['bounds']['center']['x'], asset['bounds']['center']['y'], asset['bounds']['center']['z']]
                }
                if (a == 0) {
                    centerMin[0] = Math.min(asset['bounds']['center']['x'], centerMin[0]);
                    centerMin[1] = Math.min(asset['bounds']['center']['y'], centerMin[1]);
                    centerMin[2] = Math.min(asset['bounds']['center']['z'], centerMin[2]);                            
                }
            }
        }        
        for (var w = 0; w < width; w++) {
            for (var d = 0; d < depth; d++) {
                var center_height;
                //console.log(center_height);
                heightArray.forEach(function (h) {
                    if (h[0] == w && h[1] == d) {
                        center_height = h[2] + 1.13;
                        return;
                    }
                });
                if ((Math.floor(random() * 100) + 1) > percentage) {
                    continue;
                }

                newRotation = Math.floor(Math.random() * 3) * 4
                for (var a = 0; a < customAssetPayload.length; a++) {
                    var assets = [];
                    //var centerMin;
                    for (var x = 0; x < customAssetPayload[a]['assets'].length; x++) {
                        var asset = customAssetPayload[a]['assets'][x];
                        assets.push({'rotation': newRotation + asset['rotation'],
                            'bounds': 
                            {
                                'center': {'x': (asset['bounds']['center']['x'] - centerMin[0]) + (w*2), 'y': asset['bounds']['center']['y'] - asset['bounds']['extents']['y'] + center_height, 'z': (asset['bounds']['center']['z'] - centerMin[2]) + d*2},
                                'extents': {'x': asset['bounds']['extents']['x'], 'y': 1, 'z': asset['bounds']['extents']['z']}
                            }                    
                        });
                    }
                    console.log("guid: " + customAssetPayload[a]['nguid'] + " Asset Count: " + assets.length);

                    assetPayload.push({'nguid': customAssetPayload[a]['nguid'], 'assets': assets})
                }
            }
        }
        return assetPayload;
    }

    function WriteRandomForest() { 
        clearPrintResults();

        var slab = [];

        var width = document.getElementById("widthslider").value;
        var depth = document.getElementById("depthslider").value;

        const groundsliders = document.querySelectorAll("input[groundnguid]");
        var floorvalues = {};
        groundsliders.forEach(function(percent) {
            floorvalues[percent.getAttribute("groundnguid")] = percent.value;
        });
        var floorData = AddFloor(floorvalues, width, depth, 1);
        var heightArray = floorData[1];
        var floors = floorData[0];
        floors.forEach(function (floor) {
            slab.push(floor);
        });

        // var grass_guid = "01c3a210-94fb-449f-8c47-993eda3e7126";
        // slab.push(AddAsset(grass_guid, width, depth, 1, 100));

        const sliderpercents = document.querySelectorAll("input[nguid]");
        sliderpercents.forEach(function(percent) {
            if (percent.getAttribute("custom")) {
                var customAssetData = AddCustomAsset(percent.getAttribute("nguid"), width, depth, heightArray, percent.value);
                for (var i = 0; i < customAssetData.length; i++) {
                    var found = false;
                    for (var s = 0; s < slab.length; s++) {
                        if (slab[s]['nguid'] == customAssetData[i]['nguid']) {
                            found = true;
                            for (var a = 0; a < customAssetData[i]['assets'].length; a++) {
                                slab[s]['assets'].push(customAssetData[i]['assets'][a]);
                            }
                            break;
                        }
                    }
                    if (!found) {
                        slab.push(customAssetData[i]);
                    }
                }
            } else {
                slab.push(AddAsset(percent.getAttribute("nguid"), width, depth, heightArray, percent.value)); // 1.38
            }
        });

        // console.log(slab);
        var results = TalespireSlabs.CreateSlab(slab);
        document.getElementById("forest").value = results;
        printResults(TalespireSlabs.DecodeSlab(results));
        ShowMessage("Complete", 2000);
    }    

    function ReadSlab() {
        clearPrintResults();
        try {
            printResults(TalespireSlabs.DecodeSlab(document.getElementById("forest").value));
        } catch (err) {
            console.log(err);
            ShowError(err);
        }
    }

    function RemoveFromLocal(name) {
        window.localStorage.removeItem(name);
        PopulateModalAssets();
        SwapAssets();
        ShowMessage(name.substring(name.indexOf('-') + 1) + " has been removed.", 5000);
    }

    function ShowSlabDialog() {
        document.getElementById('slabname').value = "";
        document.getElementById('SlabNameDialog').style.display = "block";
    }

    function SaveToLocal() {
        // var customSlabName = prompt("Custom Slab Name", "");
        var customSlabName = document.getElementById('slabname').value;
        console.log("Custom Slab Name: " + customSlabName);
        if (customSlabName == null) {
            return;
        }
        if (customSlabName == "") {
            ShowError("You must give the slab a name.");
        }
        clearPrintResults();
        var slabValue = document.getElementById("forest").value;
        try {
            printResults(TalespireSlabs.DecodeSlab(slabValue));
        } catch (err) {
            console.log(err);
            ShowError(err);
            return;
        }
        window.localStorage.setItem('slab-' + customSlabName, slabValue);
        PopulateModalAssets();
        SwapAssets();
        ShowMessage("Saved Slab as: " + customSlabName + " <br>To delete or select use the \"Add Asset\" window.", 6000);

    }

    function searchAssets() {
      // Declare variables
      var input, filter, table, tr, td, i, txtValue;
      input = document.getElementById("assetSearch");
      filter = input.value.toUpperCase();
      table = document.getElementById("assetTable");
      tr = table.getElementsByTagName("tr");

      // Loop through all table rows, and hide those who don't match the search query
      for (i = 0; i < tr.length; i++) {
        //td = tr[i].getElementsByTagName("td")[0];
        tds = tr[i].getElementsByTagName("td");
        for (var x = 0; x < tds.length; x++) {
          txtValue = tds[x].textContent || tds[x].innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
            break;
          } else {
            tr[i].style.display = "none";
          }

        }
      }
    }
    </script>
</head>
<body>
    <span style="margin: 10px;font-size: 120%; float: right"><a href="https://github.com/brcoding/TaleSpireHtmlSlabGeneration"><i class="fa fa-github"></i> Github Project</a></span>
    <h1 style="padding-left: 20px; padding-top: 20px">Forest Generator <img style="float: left" height="50px" src="Pine_Tree.png"></h1>

    <form onSubmit="return false;">
        <textarea style="margin: 10px; height: 200px; width: 850px; resize: vertical;" id="forest"></textarea>

        <div style="width: 850px; margin: 10px;" class="btn-group">
            <button id="button" onclick = "WriteRandomForest();">Generate Random Forest <span class="tooltip"><i class="fa fa-question-circle"></i>
          <span class="tooltiptext">Clicking this button will take the values from slab size and randomness below and create a slab that can be pasted in to TaleSpire.</span>
        </span></button>
            <button class="clipboardbutton" id="button" onclick="CopyToClipboard();">Copy To Clipboard <span class="tooltip"><i class="fa fa-question-circle"></i><span class="tooltiptext">This button copies the contents of the above into your clipboard.</span></button>
            <button class="clipboardbutton" id="button" onclick="ShowSlabDialog();">Save Custom Slab <span class="tooltip"><i class="fa fa-question-circle"></i><span class="tooltiptext">After pasting a slab you can store it as a custom asset that can be used later to insert as a random asset.</span></button>
            <button style="float: right; " id="button" onclick='ReadSlab();'>Read Pasted Slab <span class="tooltip"><i class="fa fa-question-circle"></i><span class="tooltiptext">Reads the value that has been pasted (from TaleSpire) and prints out the associated data in the Decoded Results.</span></button>
        </div>
        <div id="SlabNameDialog" class="modal">
            <div style="width: 330px; height: 220px" class="modal-content">
                <div class="modal-body">
                    <p style="font-size: 80%">Custom Slab Name</p>
                    <input style="font-size: 90%" type="text" id="slabname" placeholder="Enter Name">
                    <div style="width: 280px; margin: 10px; text-align: right" class="btn-group">
                        <button onClick='document.getElementById("SlabNameDialog").style.display = "none";SaveToLocal();'><i class="fa fa-check"> OK</i></button>
                        <button onClick='document.getElementById("SlabNameDialog").style.display = "none";'><i class="fa fa-times"> Cancel</i></button>
                    </div>

                </div>
            </div>
        </div>
        <span style="clear: both"></span>
        <div class="row">
            <div class="column">

                <div style="padding-top: 25px; float: right"><label>Presets
                <select id="presets" onchange="PopulateAssetList(presetAssets[this.value]);">
                  <option value="mixed" selected="selected">Mixed Forest</option>
                  <option value="sparsepine">Sparse Pine Forest</option>
                  <option value="heavypine">Heavy Pine Forest</option>
                  <option value="sparsedead">Sparse Dead Forest</option>
                  <option value="heavydead">Heavy Dead Forest</option>
                </select></div>
                <h3>Slab Size</h3>
                <table>
                    <tr>
                        <th><span class="sliderheader">Slab Width: <strong><span id="slabwidth"></span></strong></span></th>
                        <th><span class="sliderheader">Slab Depth: <strong><span id="slabdepth"></span></strong></span></th>
                    </tr>
                    <tr>
                        <td><input type="range" min="1" max="50" value="5" class="slider" id="widthslider"></td>
                        <td><input type="range" min="1" max="50" value="5" class="slider" id="depthslider"></td>
                    </tr>
                </table>

                <p><button onClick='ShowAssetWindow(true);' class="addbtn"><i class="fa fa-plus"> Add Ground</i></button></p>
                <h3 style='margin-top: 40px;'>Ground</h3>
                <span id="groundsliders"></span>
                <br>

                <span style="clear: both"></span>

                <br>
                <button onClick='ShowAssetWindow(false);' class="addbtn"><i class="fa fa-plus"> Add Asset</i></button>
                <h3>Randomness</h3>
                <span id="randomsliders"></span>
                <div id="AssetSelect" class="modal">

                  <!-- Modal content -->
                  <div class="modal-content">
                    <div class="modal-body">
                        <div onclick='AssetSelect.style.display = "none";' class="modalClose"><i class="fa fa-close"></i></div>
                        <h3 style="margin-top: -25px">Asset Selection</h3>
                        <input type="text" id="assetSearch" onkeyup="searchAssets()" style="font-size: 100%;font-family:Candara, Calibri, Segoe, FontAwesome" placeholder="&#xf002; Search"><label id="swapassets"><input onclick="SwapAssets()" style="margin-left: 20px;" type="checkbox" id="custom"><span style="font-size: 80%;">Show Custom Assets</span></label>
                        <div style="width: 812px;" id="assetTable"></div>

                    
                        <div onclick='AssetSelect.style.display = "none";' class="modalOk"><i class="fa fa-check-square"></i> Done</div>
                    </div>
                    
                  </div>

                </div>
                
            </div>
            <div class="column">
                <h3 style="margin-left: 40px">Decoded Results</h3>
                <p class="output" id="output"></p>
            </div>
        </div>
    </form>
    <span style="float: none"></span>
    <div id="snackbar"></div>
    <script>
        var assetWindowGround = false;
        function ShowAssetWindow(ground=false) {
            assetWindowGround = ground;
            document.getElementById('AssetSelect').style.display = "block";
            if (ground) {
                document.getElementById("custom").checked = false;
                SwapAssets();
                document.getElementById('swapassets').style.display = "none";
            } else {
                document.getElementById('swapassets').style.display = "inline";
            }
        }

        document.querySelector(".modal").addEventListener("click", function(e) {
            if (e.target.className == "modal") {
                document.getElementById('AssetSelect').style.display = "none";
            }

        });
        function SwapAssets() {
            if (document.getElementById("custom").checked) {
                document.getElementById("standardassets").style.display = "none";
                document.getElementById("customassets").style.display = "block";                
            } else {
                document.getElementById("standardassets").style.display = "block";
                document.getElementById("customassets").style.display = "none";
            }
        }
        function AddAssetToList(nguid, defaultpercent, custom=false) {
            var sliderdiv = document.createElement("div");
            sliderdiv.style.width = "400px";

            if (custom) {
                sliderdiv.innerHTML = '<p class="sliderheader"><button onClick="this.parentNode.parentNode.innerHTML=\'\';" class="btn" id="' + nguid + 'removebtn"><i class="fa fa-close"></i></button> Custom - ' + nguid.substring(nguid.indexOf('-') + 1) + ': <strong><span id="' + nguid + 'percent"></span>%</strong> </p><input type="range" min="0" max="100" nguid="' + nguid + '" custom="true" value="' + defaultpercent + '" class="sliderwide" id="' + nguid + 'slider">';
                document.getElementById("randomsliders").appendChild(sliderdiv);
                var randslider = document.getElementById(nguid + "slider");
                document.getElementById(nguid + "percent").innerHTML = randslider.value;
                randslider.oninput = function() {
                    document.getElementById(nguid + "percent").innerHTML = this.value;
                }

            } else {

                nguid = nguid.trim();

                var asset = TalespireSlabs.GetAsset(nguid);

                sliderdiv.innerHTML = '<p class="sliderheader"><button onClick="this.parentNode.parentNode.innerHTML=\'\';" class="btn" id="' + nguid + 'removebtn"><i class="fa fa-close"></i></button> ' + asset['name'] + ': <strong><span id="' + nguid + 'percent"></span>%</strong> </p><input type="range" min="0" max="100" nguid="' + nguid + '" value="' + defaultpercent + '" class="sliderwide" id="' + nguid + 'slider">';
                document.getElementById("randomsliders").appendChild(sliderdiv);
                var randslider = document.getElementById(nguid + "slider");
                document.getElementById(nguid + "percent").innerHTML = randslider.value;
                randslider.oninput = function() {
                    document.getElementById(nguid + "percent").innerHTML = this.value;
                }
            }
        }

        function AddAssetToGround(nguid, defaultpercent) {
            var sliderdiv = document.createElement("div");
            sliderdiv.style.width = "400px";

            nguid = nguid.trim();

            var asset = TalespireSlabs.GetAsset(nguid);

            sliderdiv.innerHTML = '<p class="sliderheader"><button onClick="if (document.querySelectorAll(\'input[groundnguid]\').length > 1) {this.parentNode.parentNode.innerHTML=\'\';} else {ShowError(\'Must have at least 1 ground tile\');} " class="btn" id="' + nguid + 'removebtn"><i class="fa fa-close"></i></button> ' + asset['name'] + ': <strong><span id="' + nguid + 'percent"></span>%</strong> </p><input type="range" min="1" max="100" groundnguid="' + nguid + '" value="' + defaultpercent + '" class="sliderwide" id="' + nguid + 'groundslider">';
            document.getElementById("groundsliders").appendChild(sliderdiv);
            var randslider = document.getElementById(nguid + "groundslider");
            document.getElementById(nguid + "percent").innerHTML = randslider.value;
            randslider.oninput = function() {
                document.getElementById(nguid + "percent").innerHTML = this.value;
            }
        }

        function PopulateModalAssets() {
            var tmpTable = '<span id="standardassets" style="display: block;"><table class="assetTable" style="margin-top: 20px; width: 810px" cellspacing="0" cellpadding="0" border="0"><tr></tr><tr><td style=" border: 1px solid #AAA" colspan="3"><div style="height: 400px; width: 810px; overflow-y:none; overflow-y:auto;"><table  width="790px" align="left" id="assetTable" cellspacing="0" cellpadding="0" border="1">';
            var assets = TalespireSlabs.GetAllAssets();

            tmpTable += '<tr><th>Name</th><th>GUID</th><th></th></tr>';

            Object.entries(assets).forEach(function(asset) {
                tmpTable += '<tr><td>' + asset[1]["name"] + '</td><td>' + asset[0] + '</td><td><button onClick="if (assetWindowGround) {AddAssetToGround(\'' + asset[0] + '\', 10); } else {AddAssetToList(\'' + asset[0] + '\', 10);}" class="addbtn"><i class="fa fa-plus"> Select</i></button></td></tr>';
            });
            tmpTable += "</table></div></td></tr></table></span>";

            tmpTable += '<span id="customassets" style="display: none"><table class="assetTable" style="margin-top: 20px; width: 810px" cellspacing="0" cellpadding="0" border="0"><tr></tr><tr><td style=" border: 1px solid #AAA" colspan="3"><div style="height: 400px; width: 810px; overflow-y:none; overflow-y:auto;"><table class="assetTable" width="790px" align="left" id="assetTable" cellspacing="0" cellpadding="0" border="1">';
            
            tmpTable += '<tr><th>Name</th><th></th><th></th></tr>';

            Object.entries(window.localStorage).forEach(function (storeVal) {
                // console.log(storeVal);
                if (storeVal[0].startsWith('slab-')) {
                    tmpTable += '<tr><td>' + storeVal[0].substring(storeVal[0].indexOf('-') + 1) + '</td><td><button onClick="RemoveFromLocal(\'' + storeVal[0] + '\');" class="addbtn"><i class="fa fa-trash"> Delete</i></button></td><td><button onClick="AddAssetToList(\'' + storeVal[0] + '\', 10, true);" class="addbtn"><i class="fa fa-plus"> Select</i></button></td></tr>';
                }
            });

            tmpTable += "</table></div></td></tr></table></span>";
            document.getElementById("assetTable").innerHTML = tmpTable;
        }

        PopulateModalAssets();

        var widthslider = document.getElementById("widthslider");
        document.getElementById("slabwidth").innerHTML = widthslider.value;
        widthslider.oninput = function() {
          document.getElementById("slabwidth").innerHTML = this.value;
        }            
        var depthslider = document.getElementById("depthslider");
        document.getElementById("slabdepth").innerHTML = depthslider.value;
        depthslider.oninput = function() {
          document.getElementById("slabdepth").innerHTML = this.value;
        }

        function PopulateAssetList(assetList) {
            document.getElementById("groundsliders").innerHTML = "";
            document.getElementById("randomsliders").innerHTML = "";
            assetList['randoms'].forEach(function(prop_asset){
                if (prop_asset['nguid'].startsWith('builtin')) {
                    AddAssetToList(prop_asset['nguid'], prop_asset['defaultpercent'], true);
                } else {
                    AddAssetToList(prop_asset['nguid'], prop_asset['defaultpercent']);
                }
            });
            Object.entries(assetList['floors']).forEach(function(prop_asset){
                AddAssetToGround(prop_asset[0], prop_asset[1]);
            });
        }
        
        PopulateAssetList(presetAssets['mixed']);
    </script>
    <div class="footer"><i>See more great projects at <a href="https://talestavern.com/">TalesTavern</a></i>
        <br>D20ArmyKnife Â© 2020
    </div>
</body>
</html>
